#
# For instructions refer to section 3.4 of the Emuchron pdf manual.
#
# !! Run this script with root privileges !!
# !! Prior to running this script execute "apt-get update" as root once !!
#
# This command script will install everything you need to be able to:
# - Build Monochron firmware
# - Build Emuchron and the mchron command line tool
# - Connect and upload firmware to Monochron via the FTDI port
# - Read Monochron debug strings from the FTDI port
# - Debug clock and high-level graphics code
# - Interrupt/halt debugger in Debian 8 (Jessie) and 9 (Stretch) without
#   being warned or prompted about certain libc sourcefiles not being found
#

# Compiler and AVR stuff
apt-get install gcc
apt-get install make
apt-get install flex
apt-get install byacc
apt-get install bison
apt-get install libusb-dev
apt-get install avr-libc
apt-get install gcc-avr
apt-get install avrdude

# Debugger and gui front-ends
apt-get install gdb
apt-get install ddd
apt-get install nemiver

# LCD device stubs
apt-get install libncurses5-dev
apt-get install freeglut3-dev

# Piezo (audio) device stub
apt-get install sox

# Readline library
apt-get install libreadline-dev

# Read Monochron debug strings from FTDI port
apt-get install minicom

# For a non-annoying debugging experience in Debian 8 (Jessie) we require a
# specific glibc source file named syscall-template.S
# For more info refer to section 3.7.2 of the Emuchron pdf manual.
myDebianVersion=`lsb_release -c`
if [[ $myDebianVersion == *"jessie"* ]];
then
  if [ -f /build/glibc/glibc-2.19/sysdeps/unix/syscall-template.S ];
  then
    echo "glibc sources already available"
  else
    echo "Installing/replacing glibc sources in /build/glibc"
    apt-get install dpkg-dev
    mkdir -p /build/glibc
    rm -rf /build/glibc/glibc-2.19
    cd /build/glibc
    apt-get source glibc
    cd -
  fi
  echo "Installing/replacing glibc source symbolic links"
  # When needed add new symbolic link entries below
  for i in Ir_s5K I9DIZl 3Vu5mt uPj9cH daoqzt qK83Be KShDyh 6V9RKT
  do
    rm -f /build/glibc-$i
    ln -s /build/glibc /build/glibc-$i
  done
fi

# Debian 9 (Stretch) also requires glibc sources available for an unannoying
# debugging experience, mostly being syscall-template.S and pselect.c.
# For more info refer to section 3.7.2 of the Emuchron pdf manual.
if [[ $myDebianVersion == *"stretch"* ]];
then
  if [ -f /build/glibc-2.24/sysdeps/unix/syscall-template.S ];
  then
    echo "glibc sources already available"
  else
    echo "Installing/replacing glibc sources in /build/glibc"
    apt-get install dpkg-dev
    mkdir -p /build/glibc
    rm -rf /build/glibc/glibc-2.24
    cd /build/glibc
    apt-get source glibc
    cd -
  fi
  echo "Installing/replacing glibc source symbolic links"
  # When needed add new symbolic link entries below
  for i in p3Km7c
  do
    rm -f /build/glibc-$i
    ln -s /build/glibc /build/glibc-$i
  done
fi
